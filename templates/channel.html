{% extends "base.html" %}
{% from "_macros.html" import render_dashboard_channel_card %}

{% block title %}Process Channel - YoppyChat AI{% endblock %}

{% block page_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/channel.css') }}">
{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="hero-content">
        <!-- <div class="hero-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.42a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .54 5.33A2.78 2.78 0 0 0 3.46 19c1.72.42 8.6.42 8.6.42s6.88 0 8.6-.42a2.78 2.78 0 0 0 1.94-2A29 29 0 0 0 23 11.75a29 29 0 0 0-.46-5.33z"/>
                <path d="M10 15.25l5-3.5-5-3.5v7z"/>
            </svg>
        </div> -->
        <h1 class="hero-title">Add Your YouTube Channel</h1>
        <p class="hero-subtitle">YoppyChat studies every video youâ€™ve ever publishedâ€”your insights, stories, and signature styleâ€”then lets viewers chat with an AI version of you whenever inspiration strikes.
</p>

        <form id="channelForm" class="channel-form" onsubmit="return false;">
            <div class="form-group">
                <div class="input-container">
                    <input type="url"
                           name="channel_url"
                           id="channel_url"
                           class="channel-input"
                           placeholder="Enter YouTube channel URL (e.g., https://youtube.com/@mkbhd)"
                           required
                           aria-label="YouTube Channel URL Input">
                    <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.42a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .54 5.33A2.78 2.78 0 0 0 3.46 19c1.72.42 8.6.42 8.6.42s6.88 0 8.6-.42a2.78 2.78 0 0 0 1.94-2A29 29 0 0 0 23 11.75a29 29 0 0 0-.46-5.33z"/>
                        <path d="M10 15.25l5-3.5-5-3.5v7z"/>
                    </svg>
                </div>
                <div class="input-hint">
                    Supported formats: <code>https://youtube.com/@channelname</code>
                </div>
            </div>

            {% if user_status and user_status.is_active_community_owner %}
            <div class="form-group" style="text-align: left; max-width: 500px; margin: 0 auto 1.5rem auto; display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(255, 154, 86, 0.05); border-radius: 12px;">
                <input type="checkbox" id="is_shared_channel" name="is_shared_channel" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                <label for="is_shared_channel" style="font-weight: 500; color: var(--text-secondary);">Add as a shared channel for your community</label>
            </div>
            {% endif %}

            <button type="submit" class="process-btn">
                <span class="btn-icon">ðŸš€</span>
                <span>Process Channel</span>
            </button>
        </form>

        <div id="processingContainer" class="processing-display" style="display: none;">
            <div class="processing-content">
                <div class="processing-avatar">
                    <div class="channel-card-spinner"></div>
                </div>
                <div class="processing-details">
                    <div class="processing-title">Processing Channel...</div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div id="progressBarInner" class="progress-bar-inner" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div id="progressText" class="progress-text">Starting...</div>
                </div>
            </div>
        </div>
        </div>
</div>

{% endblock %}

{% block page_scripts %}
<script>
// --- START: MODIFIED SCRIPT ---
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('channelForm');
    const urlInput = document.getElementById('channel_url');
    const processingContainer = document.getElementById('processingContainer');
    const progressBar = document.getElementById('progressBarInner');
    const progressText = document.getElementById('progressText');

    const pollingIntervals = {};

    function stopPolling(taskId) {
        if (pollingIntervals[taskId]) {
            clearInterval(pollingIntervals[taskId]);
            delete pollingIntervals[taskId];
        }
    }

    // Helper function to toggle between the form and the progress bar
    function showFormView(showForm = true) {
        form.style.display = showForm ? 'block' : 'none';
        processingContainer.style.display = showForm ? 'none' : 'block';
    }

    function checkTaskStatus(taskId) {
        fetch(`/task_result/${taskId}`)
            .then(res => res.json())
            .then(data => {
                // If the user navigated away or the view was reset, stop polling
                if (processingContainer.style.display === 'none') {
                    stopPolling(taskId);
                    return;
                }

                // Update the progress bar and status text
                if (progressBar) progressBar.style.width = `${data.progress || 0}%`;
                if (progressText) progressText.textContent = data.message || 'Processing...';

                // When the task is done, show a message and reload the page
                if (data.status === 'complete' || data.status === 'failed') {
                    stopPolling(taskId);
                    const message = data.message || (data.status === 'complete' ? 'Channel processed successfully!' : 'A processing error occurred.');
                    const type = data.status === 'complete' ? 'success' : 'error';
                    showNotification(message, type);

                    // Reload to show a clean page state
                    setTimeout(() => window.location.reload(), 2500);
                }
            })
            .catch(err => {
                console.error('Polling error:', err);
                stopPolling(taskId);
                showNotification('Error checking task status. Reloading.', 'error');
                window.location.reload();
            });
    }

    function submitChannelForm(channelUrl) {
        // Hide the form and show the progress bar container
        showFormView(false);

        const formData = new FormData();
        formData.append('channel_url', channelUrl);

        // Determine the target URL based on the checkbox for shared channels
        const isSharedCheckbox = document.getElementById('is_shared_channel');
        const isShared = isSharedCheckbox && isSharedCheckbox.checked;
        const targetUrl = isShared ? "{{ url_for('add_shared_channel') }}" : "{{ url_for('channel') }}";

        fetch(targetUrl, {
            method: 'POST',
            body: formData
        })
        .then(res => {
            if (!res.ok) {
                // When the response is not OK, we expect a JSON error object from our server.
                // We'll throw an error object that includes the JSON payload.
                return res.json().then(err => { throw err; });
            }
            return res.json();
        })
        .then(data => {
            if (data.status === 'processing' && data.task_id) {
                // Task started, begin polling for status updates
                pollingIntervals[data.task_id] = setInterval(() => checkTaskStatus(data.task_id), 3000);
                if (urlInput) urlInput.value = '';

            } else if (data.status === 'success') {
                // Handles cases where no background task is needed (e.g., re-adding)
                showNotification(data.message, 'success');
                setTimeout(() => window.location.reload(), 2000);

            } else {
                 throw new Error(data.message || 'Failed to start task.');
            }
        })
        .catch(error => {
            // The error object might have an 'action' property for specific UI responses
            if (error && error.action === 'show_upgrade_popup') {
                // This function should be globally available from base.html
                if (window.showUpgradePopup) {
                    window.showUpgradePopup(error.message);
                } else {
                    showNotification(error.message, 'error'); // Fallback
                }
            } else {
                const errorMessage = error.message || 'An unknown error occurred.';
                showNotification(errorMessage, 'error');
            }
            // On any error, show the form again
            showFormView(true);
        });
    }

    if (form) {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const userIsLoggedIn = {{ 'true' if user else 'false' }};
            const channelUrl = urlInput.value.trim();

            if (!channelUrl) {
                showNotification('Please enter a valid channel URL.', 'error');
                return;
            }

            if (!userIsLoggedIn) {
                localStorage.setItem('action_after_login', JSON.stringify({ type: 'process_channel', url: channelUrl }));
                showLoginPopup();
            } else {
                submitChannelForm(channelUrl);
            }
        });
    }

    // This part handles processing a channel URL after a user logs in
    const userIsLoggedIn = {{ 'true' if user else 'false' }};
    if (userIsLoggedIn) {
        const pendingActionJSON = localStorage.getItem('action_after_login');
        if (pendingActionJSON) {
            const pendingAction = JSON.parse(pendingActionJSON);
            localStorage.removeItem('action_after_login');

            if (pendingAction.type === 'process_channel' && pendingAction.url) {
                if (urlInput) urlInput.value = pendingAction.url;
                submitChannelForm(pendingAction.url);
            }
        }
    }
});
// --- END: MODIFIED SCRIPT ---
</script>
{% endblock %}
